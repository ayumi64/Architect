# å®¹å™¨å¦‚ä½•åŠ è½½ main.py - å®Œæ•´æµç¨‹è§£æ

## ğŸ“‹ æ•´ä½“å…³ç³»å›¾

```
docker-compose.yml (é…ç½®)
    â†“
    å®šä¹‰ volumes: ./:/app (æŒ‚è½½æœ¬åœ°ä»£ç åˆ°å®¹å™¨)
    â†“
    å®šä¹‰ environment: APP_MODULE=main:app (å‘Šè¯‰å®¹å™¨åŠ è½½å“ªä¸ªæ¨¡å—)
    â†“
å®¹å™¨å¯åŠ¨ â†’ /start.sh (å¯åŠ¨è„šæœ¬)
    â†“
    æ£€æµ‹ /app/main.py æ˜¯å¦å­˜åœ¨
    â†“
    è®¾ç½® APP_MODULE=main:app
    â†“
    Gunicorn å¯åŠ¨ â†’ åŠ è½½ main:app
    â†“
    å¯¼å…¥ main.py ä¸­çš„ app å¯¹è±¡
    â†“
    FastAPI åº”ç”¨è¿è¡Œ
```

## ğŸ” è¯¦ç»†æµç¨‹è§£æ

### 1. docker-compose.yml çš„ä½œç”¨

```yaml
services:
  fastapi-app:
    volumes:
      - ./:/app          # å…³é”®ï¼šå°†æœ¬åœ°ç›®å½•æŒ‚è½½åˆ°å®¹å™¨çš„ /app
    environment:
      - APP_MODULE=main:app  # å…³é”®ï¼šå‘Šè¯‰å®¹å™¨åŠ è½½ main.py ä¸­çš„ app å¯¹è±¡
```

**ä½œç”¨ï¼š**
- `volumes: ./:/app` â†’ å°†å½“å‰ç›®å½•ï¼ˆåŒ…å« main.pyï¼‰æŒ‚è½½åˆ°å®¹å™¨çš„ `/app` ç›®å½•
- `APP_MODULE=main:app` â†’ æŒ‡å®šè¦åŠ è½½çš„æ¨¡å—å’Œå˜é‡å

### 2. å®¹å™¨å¯åŠ¨æµç¨‹

#### æ­¥éª¤ 1: å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œ `/start.sh`

```bash
# å¯åŠ¨è„šæœ¬ä½ç½®ï¼šå®¹å™¨å†…çš„ /start.sh
```

#### æ­¥éª¤ 2: è‡ªåŠ¨æ£€æµ‹ main.py ä½ç½®

```bash
# /start.sh ä¸­çš„é€»è¾‘ï¼š
if [ -f /app/app/main.py ]; then
    DEFAULT_MODULE_NAME=app.main    # å¦‚æœåœ¨ /app/app/main.py
elif [ -f /app/main.py ]; then
    DEFAULT_MODULE_NAME=main        # å¦‚æœåœ¨ /app/main.py (æˆ‘ä»¬çš„æƒ…å†µ)
fi
```

**æˆ‘ä»¬çš„æƒ…å†µï¼š** main.py åœ¨ `/app/main.py`ï¼Œæ‰€ä»¥ `MODULE_NAME=main`

#### æ­¥éª¤ 3: è®¾ç½®ç¯å¢ƒå˜é‡

```bash
MODULE_NAME=${MODULE_NAME:-$DEFAULT_MODULE_NAME}  # main
VARIABLE_NAME=${VARIABLE_NAME:-app}                # app
export APP_MODULE=${APP_MODULE:-"$MODULE_NAME:$VARIABLE_NAME"}  # main:app
```

**ç»“æœï¼š** `APP_MODULE=main:app`

#### æ­¥éª¤ 4: å¯åŠ¨ Gunicorn

```bash
exec gunicorn -k "uvicorn.workers.UvicornWorker" -c "$GUNICORN_CONF" "main:app"
```

**å«ä¹‰ï¼š**
- `-k uvicorn.workers.UvicornWorker` â†’ ä½¿ç”¨ Uvicorn worker
- `-c "$GUNICORN_CONF"` â†’ ä½¿ç”¨ Gunicorn é…ç½®æ–‡ä»¶
- `"main:app"` â†’ **å…³é”®**ï¼šåŠ è½½ `main` æ¨¡å—ä¸­çš„ `app` å¯¹è±¡

### 3. Python æ¨¡å—åŠ è½½æœºåˆ¶

å½“ Gunicorn æ‰§è¡Œ `main:app` æ—¶ï¼š

```python
# ç­‰ä»·äºæ‰§è¡Œï¼š
from main import app  # å¯¼å…¥ main.py æ–‡ä»¶ä¸­çš„ app å¯¹è±¡
```

**main.py ä¸­çš„å…³é”®ä»£ç ï¼š**
```python
app = FastAPI(...)  # è¿™ä¸ª app å¯¹è±¡å°±æ˜¯è¢«åŠ è½½çš„
```

## ğŸ“Š å®Œæ•´åŠ è½½é“¾è·¯

```
1. docker-compose up
   â†“
2. Docker æŒ‚è½½å·ï¼š./ â†’ /app
   â†“
3. å®¹å™¨å¯åŠ¨ï¼Œæ‰§è¡Œ /start.sh
   â†“
4. æ£€æµ‹åˆ° /app/main.py å­˜åœ¨
   â†“
5. è®¾ç½® APP_MODULE=main:app
   â†“
6. Gunicorn å¯åŠ¨å‘½ä»¤ï¼šgunicorn ... "main:app"
   â†“
7. Python è§£é‡Šå™¨æ‰§è¡Œï¼šfrom main import app
   â†“
8. åŠ è½½ /app/main.py æ–‡ä»¶
   â†“
9. åˆ›å»º app = FastAPI(...) å¯¹è±¡
   â†“
10. Gunicorn ä½¿ç”¨ app å¯¹è±¡å¯åŠ¨ Web æœåŠ¡å™¨
   â†“
11. FastAPI åº”ç”¨è¿è¡Œï¼Œå¤„ç† HTTP è¯·æ±‚
```

## ğŸ”§ å…³é”®é…ç½®è¯´æ˜

### docker-compose.yml ä¸­çš„å…³é”®é…ç½®

| é…ç½®é¡¹ | ä½œç”¨ | ç¤ºä¾‹å€¼ |
|--------|------|--------|
| `volumes: ./:/app` | æŒ‚è½½æœ¬åœ°ä»£ç åˆ°å®¹å™¨ | æœ¬åœ° `./` â†’ å®¹å™¨ `/app` |
| `APP_MODULE=main:app` | æŒ‡å®šåŠ è½½çš„æ¨¡å—å’Œå˜é‡ | `main:app` = `main.py` ä¸­çš„ `app` |
| `MODULE_NAME=main` | Python æ¨¡å—å | å¯¹åº” `main.py` |
| `VARIABLE_NAME=app` | FastAPI åº”ç”¨å˜é‡å | å¯¹åº” `app = FastAPI(...)` |

### main.py ä¸­çš„å…³é”®ä»£ç 

```python
# main.py
app = FastAPI(...)  # è¿™ä¸ªå˜é‡åå¿…é¡»å’Œ VARIABLE_NAME ä¸€è‡´
```

**æ³¨æ„ï¼š** å¦‚æœ `VARIABLE_NAME=myapp`ï¼Œé‚£ä¹ˆ main.py ä¸­åº”è¯¥æ˜¯ `myapp = FastAPI(...)`

## ğŸ¯ å®é™…éªŒè¯

### æŸ¥çœ‹å®¹å™¨å†…çš„å®é™…é…ç½®

```bash
# æŸ¥çœ‹æŒ‚è½½çš„ç›®å½•
docker exec fastapi-app ls -la /app/

# æŸ¥çœ‹ç¯å¢ƒå˜é‡
docker exec fastapi-app printenv | grep APP_MODULE

# æŸ¥çœ‹å¯åŠ¨å‘½ä»¤
docker exec fastapi-app ps aux | grep gunicorn
```

### ä¿®æ”¹é…ç½®çš„å½±å“

1. **ä¿®æ”¹ main.py** â†’ é‡å¯å®¹å™¨åç”Ÿæ•ˆï¼ˆå› ä¸ºä½¿ç”¨äº†å·æŒ‚è½½ï¼‰
2. **ä¿®æ”¹ APP_MODULE** â†’ å¯ä»¥åŠ è½½ä¸åŒçš„æ¨¡å—æˆ–å˜é‡
3. **ä¿®æ”¹ volumes** â†’ å¯ä»¥æŒ‚è½½ä¸åŒçš„ä»£ç ç›®å½•

## ğŸ’¡ å¸¸è§åœºæ™¯

### åœºæ™¯ 1: main.py åœ¨å­ç›®å½•

å¦‚æœä»£ç ç»“æ„æ˜¯ï¼š
```
/app/app/main.py
```

éœ€è¦è®¾ç½®ï¼š
```yaml
environment:
  - APP_MODULE=app.main:app
```

### åœºæ™¯ 2: ä½¿ç”¨ä¸åŒçš„å˜é‡å

å¦‚æœ main.py ä¸­æ˜¯ï¼š
```python
api = FastAPI(...)
```

éœ€è¦è®¾ç½®ï¼š
```yaml
environment:
  - APP_MODULE=main:api
  - VARIABLE_NAME=api
```

### åœºæ™¯ 3: ä¸ä½¿ç”¨ docker-compose

ç›´æ¥ä½¿ç”¨ docker runï¼š
```bash
docker run -d \
  -p 8000:80 \
  -v $(pwd):/app \
  -e APP_MODULE=main:app \
  tiangolo/uvicorn-gunicorn-fastapi:python3.10-2025-11-10
```

## ğŸ”„ æ€»ç»“

1. **docker-compose.yml** â†’ é…ç½®æŒ‚è½½å’Œç¯å¢ƒå˜é‡
2. **volumes æŒ‚è½½** â†’ å°†æœ¬åœ°ä»£ç æ˜ å°„åˆ°å®¹å™¨
3. **/start.sh è„šæœ¬** â†’ è‡ªåŠ¨æ£€æµ‹å¹¶è®¾ç½® APP_MODULE
4. **Gunicorn** â†’ æ ¹æ® APP_MODULE åŠ è½½ Python æ¨¡å—
5. **main.py** â†’ æä¾› FastAPI åº”ç”¨å¯¹è±¡
6. **app å¯¹è±¡** â†’ è¢« Gunicorn ä½¿ç”¨æ¥å¯åŠ¨ Web æœåŠ¡å™¨

æ•´ä¸ªæµç¨‹æ˜¯è‡ªåŠ¨åŒ–çš„ï¼Œä½ åªéœ€è¦ï¼š
- ç¡®ä¿ main.py åœ¨æ­£ç¡®çš„ä½ç½®
- ç¡®ä¿ app = FastAPI(...) å˜é‡åæ­£ç¡®
- docker-compose.yml é…ç½®æ­£ç¡®

å®¹å™¨ä¼šè‡ªåŠ¨å®Œæˆå…¶ä½™çš„å·¥ä½œï¼

